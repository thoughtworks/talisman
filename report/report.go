package report

import (
	"encoding/json"
	"html/template"
	"log"
	"os"
	"path/filepath"
	"talisman/detector"
)

const reportsFolder = "talisman_reports"
const htmlFileName string = "report.html"
const jsonFileName string = "report.json"
// GenerateReport generates a talisman scan report in html format
func GenerateReport(r *detector.DetectionResults, directory string) string {

	var path string
	var htmlFilePath string
	var jsonFilePath string

	path = filepath.Join(directory, "talisman_reports")
	htmlFilePath = filepath.Join(directory, reportsFolder, htmlFileName)
	jsonFilePath = filepath.Join(directory, reportsFolder, jsonFileName)
	os.MkdirAll(path, 0755)


	reportHTML := getReportHTML()
	reportTemplate := template.New("report")
	reportTemplate, _ = reportTemplate.Parse(reportHTML)
	htmlFile, err := os.Create(htmlFilePath)
	if err != nil {
		log.Fatal("Cannot create report.html file", err)
	}
	reportTemplate.ExecuteTemplate(htmlFile, "report", r)
	htmlFile.Close()

	jsonFile, err := os.Create(jsonFilePath)
	if err != nil {
		log.Fatal("Cannot create report.json file", err)

	}
	//jsonResultSchema := detector.GetJsonSchema(r)
	jsonString, err := json.Marshal(r)
	if err != nil {
		log.Fatal("Unable to marshal JSON")
	}
	jsonFile.Write(jsonString)
	jsonFile.Close()
	return path
}

func getReportHTML() string {
	return `
	<html>
		<head>
			<style>
				body {
					background-image: radial-gradient(at center center, rgb(69, 72, 77) 0%, rgb(17, 17, 17) 100%);
					font-family: "Helvetica Neue",Helvetica,sans-serif;
				}
				svg.banner {
					width: 5%;
					height: auto;
				}
				table {
					border-collapse: collapse;
				}
				.commits_table, .details {
					width: 100%;
				}
				.report-table {
					width: 80%;
					margin: auto;
					background-color: #DCDCDC;
				}
				td, th {
					border: 1px solid #dddddd;
					padding: 8px;
					text-align: center;
				}
				.report-table > tbody > tr > td:first-child {
					vertical-align: top;
				}
				.report-table th {
					background-color: dimgrey;
					color: lightgrey;
				}
				.report-table > tbody > tr > td {
					border: 1px solid grey;
				}
				.failure-message {
					word-break: break-word;
				}
				#message-heading {
					margin-left: 15%;
				}
				#commit-heading {
					margin-left: 35%;
				}
				.details > tbody > tr > td {
					border: 1px solid #A9A9A9;
					width: 60%;
				}
				#file-path {
					width: 25%;
				}
				#heading {
					font-size: 40px;
					font-weight: 300;
					color: lightgrey;
					text-align: center;
				}
				#logo {
					padding-top: 26px;
					text-align: center;
				}
				.site-footer {
					border-top: 1px solid #424242;
					padding: 20px 0 25px 0;
					position: absolute;
					text-align: center;
					width: 100%;
					margin-top: 40px;
				}
				.footer-heading{
					font-size:18px;
					margin-bottom:15px;
					font-weight: 300;
					color: #c2c2c2;
				}
				a {
					color: #1756a9;
					text-decoration: none;
				}
				a:hover {
					color: #111;
				}
				.scan-report {
					min-height: calc(100vh - 400px);
				}
				.details > tbody > tr:first-child > td:last-child {
					border-top: 0px;
				}
				.details > tbody > tr:last-child > td:first-child {
					border-bottom: 0px;
				}
				.details > tbody > tr > td:last-child {
					border-bottom: 0px;
					border-right: 0px;
				}
				.details > tbody > tr > td:first-child {
					border-top: 0px;
					border-left: 0px;
				}

			</style>
			<title>Talisman Report</title>
		</head>
		<body>
			<div id="logo">
				<!-- Generator: Adobe Illustrator 19.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
				<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
					width="62" height="79px" viewBox="0 0 520 660" enable-background="new 0 0 520 660" xml:space="preserve">
					<defs>
					<style type="text/css"><![CDATA[
						path {
						fill: rgba(232,232,232,0.5);
						}
					]]>
					</style>
					</defs>
				<g>
					<path d="M498.799,325.528l-78.753-100.597v-68.132c0-4.015-3.252-7.26-7.26-7.26h-51.761L265.713,27.788
						C264.341,26.024,262.229,25,260,25c-2.229,0-4.341,1.024-5.713,2.788l-95.312,121.752h-51.761c-4.007,0-7.26,3.245-7.26,7.26
						v68.132L21.201,325.528c-2.062,2.628-2.062,6.316,0,8.944l78.753,100.597v68.132c0,4.015,3.252,7.26,7.26,7.26h51.761
						l95.312,121.752c1.372,1.764,3.485,2.788,5.713,2.788c2.229,0,4.341-1.024,5.713-2.788l95.312-121.752h51.761
						c4.007,0,7.26-3.245,7.26-7.26v-68.132l78.753-100.597C500.861,331.844,500.861,328.156,498.799,325.528z M399.719,164.059
						c3.209,0,5.808,2.599,5.808,5.808v36.516l-33.133-42.324H399.719z M114.473,169.866c0-3.209,2.599-5.808,5.808-5.808h27.325
						l-33.133,42.324V169.866z M120.281,495.941c-3.209,0-5.808-2.599-5.808-5.808v-36.516l33.133,42.324H120.281z M405.527,490.133
						c0,3.209-2.599,5.808-5.808,5.808h-27.325l33.133-42.324V490.133z M481.064,333.579l-216.49,276.542
						c-2.323,2.969-6.824,2.969-9.147,0L38.936,333.579c-1.641-2.105-1.641-5.053,0-7.158l216.49-276.542
						c2.323-2.969,6.824-2.969,9.147,0l216.49,276.542C482.705,328.526,482.705,331.474,481.064,333.579z"/>
					<g>
						<path d="M259.999,140.41c-2.005,0-3.63,1.625-3.63,3.63v51.97c0,2.005,1.625,3.63,3.63,3.63c2.005,0,3.629-1.625,3.629-3.63
							v-51.97C263.628,142.035,262.003,140.41,259.999,140.41z"/>
						<path d="M259.999,460.363c-2.005,0-3.63,1.625-3.63,3.63v23.721c0,2.005,1.625,3.63,3.63,3.63c2.005,0,3.629-1.625,3.629-3.63
							v-23.721C263.628,461.988,262.003,460.363,259.999,460.363z"/>
						<path d="M209.137,209.632c0.412,0,0.831-0.071,1.241-0.22c1.884-0.686,2.855-2.768,2.169-4.652l-4.772-13.111
							c-0.686-1.884-2.769-2.856-4.652-2.169c-1.884,0.686-2.855,2.768-2.169,4.652l4.772,13.111
							C206.262,208.717,207.654,209.632,209.137,209.632z"/>
						<path d="M163.36,224.907c-1.289-1.537-3.578-1.737-5.114-0.449c-1.536,1.288-1.737,3.578-0.449,5.114l5.79,6.906
							c0.718,0.856,1.747,1.298,2.783,1.298c0.823,0,1.65-0.278,2.33-0.848c1.536-1.288,1.737-3.578,0.449-5.114L163.36,224.907z"/>
						<path d="M469.325,325.528L265.713,65.436c-1.372-1.757-3.485-2.788-5.713-2.788c-2.229,0-4.341,1.031-5.713,2.788L50.675,325.528
							c-2.062,2.628-2.062,6.316,0,8.944l203.612,260.092c1.372,1.757,3.485,2.788,5.713,2.788c2.229,0,4.341-1.031,5.713-2.788
							l203.612-260.092C471.387,331.844,471.387,328.156,469.325,325.528z M451.59,333.579l-6.679,8.53h-51.834
							c-2.004,0-3.63,1.626-3.63,3.63c0,2.004,1.626,3.63,3.63,3.63h46.15l-35.173,44.937l-22.701-8.269
							c-1.88-0.682-3.964,0.283-4.653,2.171c-0.682,1.88,0.283,3.964,2.171,4.653l20.472,7.456l-27.216,34.767l-15.318-12.85
							c-1.532-1.292-3.826-1.089-5.111,0.45c-1.292,1.532-1.089,3.826,0.45,5.111l15.499,13.009l-11.144,14.236l-15.579-18.519
							c-1.292-1.532-3.579-1.735-5.118-0.443c-1.532,1.285-1.735,3.572-0.443,5.111l16.567,19.695l-12.233,15.623l-16.472-28.53
							c-1.002-1.735-3.223-2.33-4.958-1.329c-1.735,1.002-2.33,3.223-1.329,4.958l17.939,31.064l-14.454,18.461l-16.262-44.69
							c-0.69-1.88-2.773-2.853-4.653-2.171c-1.88,0.69-2.853,2.773-2.171,4.653l17.815,48.945l-18.672,23.848l-12.334-69.925
							c-0.348-1.975-2.229-3.289-4.203-2.94c-1.975,0.348-3.289,2.229-2.94,4.203l13.459,76.343l-25.888,33.075
							c-0.283,0.363-0.603,0.682-0.944,0.958v-69.315c0-2.004-1.626-3.63-3.63-3.63c-2.004,0-3.63,1.626-3.63,3.63v69.315
							c-0.341-0.276-0.661-0.595-0.944-0.958l-25.888-33.068l13.452-76.35c0.348-1.975-0.966-3.855-2.94-4.203
							c-1.975-0.348-3.855,0.966-4.203,2.94l-12.327,69.925l-38.389-49.032l17.939-31.071c1.002-1.735,0.407-3.956-1.329-4.958
							c-1.735-1.002-3.957-0.407-4.958,1.328l-16.472,28.538l-12.218-15.608l2.962-3.528c1.285-1.532,1.089-3.819-0.45-5.111
							c-1.532-1.285-3.819-1.089-5.111,0.45l-1.975,2.345l-11.165-14.265l15.499-13.009c1.539-1.285,1.742-3.579,0.45-5.111
							c-1.285-1.539-3.579-1.735-5.111-0.45l-15.318,12.85l-11.013-14.069l16.32-9.423c1.735-1.002,2.33-3.223,1.329-4.958
							c-1.002-1.735-3.223-2.33-4.958-1.329l-17.213,9.938l-29.794-38.055l29.677-5.234c1.975-0.341,3.289-2.229,2.94-4.203
							c-0.348-1.975-2.229-3.296-4.203-2.94l-33.482,5.895l-16.704-21.336h20.095c2.004,0,3.63-1.626,3.63-3.63
							c0-2.004-1.626-3.63-3.63-3.63H75.089l-6.679-8.53c-1.648-2.105-1.648-5.053,0-7.158l7.412-9.467l3.165,0.552
							c0.218,0.044,0.428,0.058,0.639,0.058c1.728,0,3.26-1.241,3.565-2.998c0.312-1.764-0.711-3.448-2.338-4.036l15.913-20.334
							l31.775,11.565c0.407,0.145,0.828,0.218,1.241,0.218c1.481,0,2.875-0.915,3.412-2.388c0.682-1.88-0.283-3.964-2.171-4.653
							l-29.547-10.752l13.902-17.757l0.29,0.167c0.574,0.327,1.198,0.486,1.815,0.486c1.249,0,2.468-0.653,3.143-1.815
							c0.886-1.532,0.523-3.441-0.777-4.559L133,243.915l14.686,12.32c0.675,0.574,1.503,0.849,2.33,0.849
							c1.031,0,2.062-0.443,2.78-1.299c1.292-1.532,1.089-3.826-0.45-5.111l-14.868-12.479l32.371-41.351l13.307,23.049
							c0.675,1.162,1.895,1.815,3.143,1.815c0.617,0,1.241-0.16,1.815-0.486c1.735-1.002,2.33-3.223,1.329-4.958L174.67,190.68
							l17.089-21.823l3.586,9.866c0.537,1.474,1.931,2.388,3.412,2.388c0.414,0,0.835-0.073,1.241-0.218
							c1.88-0.69,2.853-2.766,2.171-4.653l-5.14-14.12l21.96-28.051l11.478,65.09c0.305,1.757,1.837,2.998,3.564,2.998
							c0.211,0,0.421-0.014,0.639-0.058c1.975-0.348,3.289-2.229,2.94-4.203l-12.603-71.515l30.418-38.854
							c0.283-0.363,0.603-0.682,0.944-0.958v41.068c0,2.004,1.626,3.63,3.63,3.63c2.004,0,3.63-1.626,3.63-3.63V86.569
							c0.341,0.276,0.661,0.595,0.944,0.958l30.418,38.854l-6.345,35.979c-0.348,1.975,0.966,3.855,2.94,4.203
							c0.211,0.044,0.428,0.058,0.639,0.058c1.728,0,3.26-1.241,3.564-2.998l5.22-29.554l44.32,56.611l-2.94,5.096
							c-1.002,1.735-0.407,3.957,1.329,4.958c0.574,0.334,1.198,0.486,1.815,0.486c1.249,0,2.476-0.653,3.143-1.815l1.474-2.555
							l14.505,18.519l-13.801,16.45c-1.292,1.532-1.089,3.819,0.45,5.111c0.675,0.574,1.503,0.849,2.33,0.849
							c1.031,0,2.062-0.443,2.78-1.299l12.813-15.267l30.875,39.442l-19.645,11.34c-1.735,1.002-2.33,3.223-1.329,4.958
							c0.675,1.162,1.895,1.815,3.143,1.815c0.617,0,1.241-0.16,1.815-0.486l20.53-11.855l13.895,17.75l-4.436,1.612
							c-1.88,0.69-2.853,2.773-2.171,4.653c0.537,1.474,1.931,2.388,3.412,2.388c0.414,0,0.835-0.073,1.241-0.218l6.664-2.425
							l28.363,36.233C453.238,328.526,453.238,331.474,451.59,333.579z"/>
						<path d="M137.726,278.767c1.254,0,2.475-0.651,3.147-1.816c1.002-1.736,0.408-3.956-1.329-4.958l-6.262-3.615
							c-1.737-1.002-3.957-0.407-4.958,1.329c-1.002,1.736-0.408,3.956,1.329,4.958l6.262,3.615
							C136.486,278.61,137.11,278.767,137.726,278.767z"/>
						<path d="M366.815,411.601l6.694,3.86c0.571,0.33,1.195,0.486,1.81,0.486c1.255,0,2.476-0.652,3.148-1.817
							c1.002-1.737,0.406-3.957-1.331-4.958l-6.694-3.86c-1.737-1.002-3.956-0.406-4.958,1.331
							C364.483,408.38,365.079,410.6,366.815,411.601z"/>
						<path d="M126.243,325.786c1.728,0,3.26-1.239,3.57-3c0.348-1.974-0.969-3.857-2.944-4.206l-30.683-5.415
							c-1.973-0.347-3.857,0.969-4.205,2.944c-0.348,1.974,0.969,3.857,2.944,4.206l30.683,5.415
							C125.821,325.768,126.034,325.786,126.243,325.786z"/>
						<path d="M387.778,371.951l22.662,3.999c0.213,0.038,0.426,0.056,0.635,0.056c1.728,0,3.26-1.239,3.57-3
							c0.348-1.974-0.97-3.857-2.944-4.206l-22.662-3.998c-1.977-0.347-3.857,0.971-4.206,2.944
							C384.486,369.72,385.804,371.603,387.778,371.951z"/>
						<path d="M126.923,342.108h-9.666c-2.005,0-3.63,1.625-3.63,3.63s1.625,3.63,3.63,3.63h9.666c2.005,0,3.63-1.625,3.63-3.63
							S128.928,342.108,126.923,342.108z"/>
						<path d="M390.184,322.785c0.311,1.761,1.842,3.001,3.57,3.001c0.209,0,0.421-0.018,0.635-0.056l37.19-6.555
							c1.974-0.348,3.292-2.231,2.944-4.205c-0.348-1.974-2.226-3.287-4.205-2.945l-37.19,6.555
							C391.154,318.929,389.836,320.811,390.184,322.785z"/>
						<path d="M138.645,386.04l-13.306,4.846c-1.884,0.686-2.855,2.769-2.169,4.653c0.537,1.474,1.928,2.388,3.411,2.388
							c0.412,0,0.832-0.071,1.242-0.22l13.306-4.846c1.884-0.686,2.855-2.769,2.169-4.653
							C142.611,386.325,140.527,385.355,138.645,386.04z"/>
						<path d="M390.224,301.968c0.413,0,0.832-0.071,1.242-0.22l10.106-3.681c1.884-0.686,2.855-2.77,2.169-4.653
							c-0.686-1.884-2.769-2.854-4.653-2.169l-10.106,3.681c-1.884,0.686-2.855,2.77-2.169,4.653
							C387.35,301.053,388.742,301.968,390.224,301.968z"/>
						<path d="M369.983,257.082c0.823,0,1.652-0.279,2.332-0.85l9.739-8.176c1.536-1.289,1.735-3.579,0.446-5.114
							c-1.287-1.535-3.579-1.736-5.114-0.446l-9.739,8.176c-1.536,1.289-1.735,3.579-0.446,5.114
							C367.919,256.641,368.947,257.082,369.983,257.082z"/>
						<path d="M179.086,436.52l-3.217,3.828c-1.29,1.535-1.091,3.825,0.444,5.114c0.681,0.571,1.509,0.851,2.334,0.851
							c1.035,0,2.063-0.44,2.781-1.295l3.217-3.828c1.29-1.535,1.091-3.825-0.444-5.114C182.666,434.788,180.376,434.985,179.086,436.52
							z"/>
						<path d="M331.888,221.229c0.572,0.33,1.196,0.487,1.811,0.487c1.255,0,2.475-0.651,3.147-1.816l3.681-6.376
							c1.002-1.736,0.408-3.956-1.329-4.958c-1.739-1.004-3.957-0.407-4.958,1.329l-3.681,6.376
							C329.557,218.007,330.151,220.227,331.888,221.229z"/>
						<path d="M220.5,454.272c-1.885-0.687-3.967,0.286-4.652,2.169l-14.34,39.396c-0.686,1.884,0.285,3.967,2.169,4.652
							c0.41,0.15,0.829,0.22,1.241,0.22c1.483,0,2.875-0.915,3.411-2.389l14.34-39.396C223.355,457.04,222.384,454.958,220.5,454.272z"/>
						<path d="M309.62,209.412c0.41,0.149,0.829,0.22,1.241,0.22c1.482,0,2.875-0.916,3.411-2.39l10.732-29.494
							c0.686-1.884-0.286-3.967-2.169-4.652c-1.882-0.684-3.967,0.286-4.652,2.17l-10.732,29.494
							C306.765,206.644,307.736,208.727,309.62,209.412z"/>
						<path d="M285.329,202.092c0.213,0.038,0.426,0.056,0.635,0.056c1.728,0,3.26-1.239,3.57-3l3.428-19.43
							c0.348-1.974-0.97-3.857-2.944-4.205c-1.974-0.346-3.857,0.97-4.205,2.944l-3.428,19.43
							C282.037,199.861,283.355,201.744,285.329,202.092z"/>
					</g>
					<path d="M260.004,445.136c-0.823,0-1.645-0.14-2.432-0.419c-0.974-0.346-24.135-8.667-47.626-24.535
						c-32.18-21.738-49.189-47.284-49.189-73.878v-77.67c0-4.009,3.25-7.26,7.26-7.26c21.024,0,21.024-9.995,21.024-13.757
						c0-2.693-0.501-5.313-1.488-7.787c-0.787-1.972-0.671-4.189,0.316-6.068c0.988-1.879,2.748-3.232,4.818-3.702
						c18.306-4.16,42.213-6.451,67.318-6.451c25.097,0,49.004,2.291,67.317,6.451c2.07,0.47,3.831,1.823,4.818,3.702
						c0.988,1.879,1.103,4.097,0.316,6.068c-0.988,2.474-1.488,5.095-1.488,7.787c0,3.762,0,13.757,21.017,13.757
						c4.009,0,7.26,3.25,7.26,7.26v77.67c0,26.593-17.008,52.14-49.186,73.877c-23.489,15.868-46.647,24.188-47.622,24.535
						C261.649,444.996,260.826,445.136,260.004,445.136z M178.899,275.002c-2.088,0.374-3.623,2.169-3.623,4.291v67.011
						c0,46.426,65.884,76.177,83.094,83.153c1.048,0.425,2.212,0.424,3.26-0.001c17.197-6.989,83.094-36.806,83.094-83.151v-67.011
						c0-2.121-1.534-3.917-3.623-4.291c-22.015-3.946-24.654-19.961-24.654-27.384c0-0.406,0.007-0.811,0.02-1.216
						c0.072-2.153-1.503-4.019-3.628-4.37c-15.394-2.536-33.709-3.905-52.836-3.905c-19.13,0-37.446,1.368-52.836,3.904
						c-2.125,0.35-3.7,2.217-3.628,4.37c0.014,0.404,0.02,0.81,0.02,1.216C203.56,255.041,200.919,271.057,178.899,275.002z"/>
					<path d="M301.097,296.658h-10.091v-17.706c0-17.096-13.91-31.006-31.006-31.006c-17.096,0-31.006,13.91-31.006,31.006v17.706
						h-10.091c-4.007,0-7.26,3.252-7.26,7.26v82.194c0,4.007,3.252,7.26,7.26,7.26h82.194c4.007,0,7.26-3.252,7.26-7.26v-82.194
						C308.357,299.91,305.104,296.658,301.097,296.658z M243.513,278.951c0-9.089,7.398-16.487,16.487-16.487
						c9.089,0,16.487,7.398,16.487,16.487v17.706h-32.973V278.951z M293.837,373.044c0,3.209-2.599,5.808-5.808,5.808H231.97
						c-3.209,0-5.808-2.599-5.808-5.808v-56.059c0-2.12,1.133-3.978,2.831-4.987c0.871-0.523,1.888-0.82,2.976-0.82h56.059
						c1.089,0,2.105,0.298,2.977,0.82c1.699,1.009,2.831,2.868,2.831,4.987V373.044z"/>
					<path d="M265.65,348.203c3.706-2.009,6.222-5.932,6.222-10.444c0-6.557-5.315-11.872-11.872-11.872
						c-6.557,0-11.872,5.315-11.872,11.872c0,4.511,2.517,8.435,6.222,10.444l-5.099,11.889c-0.822,1.916,0.584,4.048,2.669,4.048h16.16
						c2.085,0,3.491-2.132,2.669-4.048L265.65,348.203z"/>
				</g>
				</svg>
			</div>

			<h1 id="heading">Talisman Scan Report</h1>
			<div class="scan-report">
				<table class="report-table">
					<tr>
						<th id="file-path">File Path</th>
						<th>
							<span id="message-heading">Message</span>
							<span id="commit-heading">Found in Commit (Git SHAs)</span>
						</th>
					</tr>
					{{range $filePath, $FailureData := .Failures}}
						<tr>
							<td>{{$filePath}}</td>
							<td>
								<table class="details">
									{{range $failureMessage, $commits := $FailureData.FailuresInCommits}}
										<tr>
											<td class="failure-message">
												{{$failureMessage}}
											</td>
											<td>
												<table>
												{{range $commit := $commits}}
													<tr><td>{{$commit}}</td></tr>
												{{end}}
												</table>
											</td>
										</tr>
									{{end}}
								</table>
							</td>
						</tr>
					{{end}}
				</table>
			</div>
			<footer class="site-footer">
  				<div class="wrapper">
    				<h3 class="footer-heading"><a href="https://github.com/thoughtworks/talisman/">GitHub</a></h3>
    				<h2 class="footer-heading">&#9400; 2016&nbsp;ThoughtWorks, Inc.</h2>
  				</div>
			</footer>
		</body>
	</html>`
}
